document.addEventListener("DOMContentLoaded",function(){function e(e,t,i,o){return r&&(3&e)==e&&(3&t)==t&&q[o||r][i]&1<<4*t+e}function t(){for(v=f;r&&!i(s,v+1,c);v++);for(m=0;O+4>m;m++)for(b=0;N>b;b++)x=m*N+b,m>=O&&(C[x]=e(b,m-O,0,G[0])?G[0]:0),M[x]=e(b-s,m-f,c)?r:e(b-s,m-v,c)?r+7:C[x]||0,(y=document.getElementById("tis-"+x))&&(y.style.background=E[M[x]]);v='<div style="text-align:right;font-size:150%">',document.getElementById("tis-status").innerHTML="Score"+v+I+"</div>Lines"+v+Y+"</div>Level"+v+$+"</div>"}function i(t,i,o){for(m=i;i+4>m;m++)for(b=t;t+4>b;b++)if(e(b-t,m-i,o)&&(0>b||b>=N||0>m||m>=O||C[m*N+b]))return 1;return 0}function o(){if(G.length<2)for(v=1,x=0;7>x;x++){for(S=0;v&1<<S;)S=Math.ceil(7*Math.random());v|=1<<S,G.push(S)}r=G.shift(),s=3,f=0,c=0,h=0,A=0,t()}function d(e){switch(u=(e-l)/1e3||0,l=e,K){case 1:if(p>1){for(b=0;N>b;b++)C[p*N+b]=1+Math.floor(7*Math.random());t(),p--}break;case 0:for(g in H){switch(parseInt(g)){case 37:if(H[g]<0)break;H[g]-=B,i(s-1,f,c)||(s--,A=0,t());break;case 39:if(H[g]<0)break;H[g]-=B,i(s+1,f,c)||(s++,A=0,t());break;case 38:if(H[g])break;for(;!i(s,f+1,c);)f++;A=9;break;case 90:case 186:H[g]||i(s,f,(c+3)%4)||(c=(c+3)%4,A=0,t());break;case 88:case 81:H[g]||i(s,f,(c+1)%4)||(c=(c+1)%4,A=0,t())}H[g]+=u}if(h+=Math.max(H[40]?.2:0,u*($+1)/1.5),h>1&&(h=0,i(s,f+1,c)||(f++,A=0,t())),A>1&&i(s,f+1,c)){for(t(),x=0;T>x;x++)C[x]=M[x];for(g=0,m=0;O>m;m++){for(v=1,b=0;N>b;b++)if(!C[m*N+b]){v=0;break}if(v)for(g++,x=m*N+N-1;x>=0;x--)C[x]=C[x-N]}I+=[0,100,300,500,800][g]*$,Y+=g,$=1+Math.floor(Y/10),o(),i(s,f,c)&&(K=1,p=O),t()}A+=u}window.requestAnimationFrame(d)}function a(e){77==e.keyCode&&(v=document.getElementById("tis-music"),v.paused?v.play():v.pause()),H[e.keyCode]||(H[e.keyCode]=0)}function n(e){delete H[e.keyCode]}var r,s,f,c,p,h,u,l,x,S,b,m,v,g,y,L=(document.getElementById("tis-grid"),["`+,^,+Y),`.,C,^`\\Yq^.1e31H,01.,C,^`\\Yq","T$$T,+)$),Y))<$TTYTl.).1^..D,\\.,<$TTTTT`"]),k="GNKNGNKNLSOSLSOSKSNSKSNSLSNSL@BCESOSESOSCOCOCOCOBNBN?J?J@CGL@@@@",w="LSOSLSOSKSNSKSNSLSOSLSOSKSNSKSNS",C=[],M=[],N=10,O=22,T=N*O+40,E="#080808 #0dd #36f #e80 #dd0 #0e0 #c0c #f22 #002c2c #0a1433 #301b00 #2c2c00 #003000 #290029 #330707".split(" "),q=[,[240,17476,3840,8738],[113,550,1136,802],[116,1570,368,547],[102,102,102,102],[54,1122,864,561],[114,610,624,562],[99,612,1584,306]],B=.15,K=0,I=0,Y=0,$=1,A=0,G=[],H=[],U='<div id="tis-root" style="position:fixed;width:280px;height:400px;left:50%;top:50%;margin:-240px -160px;background:rgba(0,0,0,0.8);box-shadow:0 0 30px #000;border-radius:30px;padding:40px"><div id="tis-grid" style="background:#000;width:200px;height:400px;box-shadow:0 0 10px #222;">';for(L[0]=L[0]+L[0]+"xtvstqpsxtvs\\`}|x",L[1]=L[1]+L[1]+"tqspqqpptqspY`xx",k=k+k+w+w,g='" style="width:20px;height:20px;float:left;box-shadow:-2px -2px 8px rgba(0,0,0,0.4) inset, 0 0 2px #000 inset;"></div>',x=0;T>x;x++)C.push(0),x>19&&220>x&&(U+='<div id="tis-'+x+g);for(U+='</div><div style="position:absolute;right:20px;top:40px;width:80px;color:#eee;font:normal 15px sans-serif"><div id="tis-status"></div>Next<br>',x=220;T>x;x++)4>x%N&&(U+='<div id="tis-'+x+g);for(U+="</div></div>",g=881856,v=new Uint8Array(g+44),v.set([82,73,70,70,g+36&255,g+36>>8&255,g+36>>16,0,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,34,86,0,0,34,86,0,0,1,0,8,0,100,97,116,97,255&g,g>>8&255,g>>16,0]),u=0;2>u;u++)for(x=44,S=0;S<L[u].length;S++)for(y=L[u].charCodeAt(S)-32,b=2*Math.PI*261.63*Math.pow(2,y%24/12)/22050,g=.2-.1*u,m=0;m<4593*[1,3,2,4][Math.floor(y/24)];m++)v[x++]+=127*(1-u+g*(Math.sin(m*b)>0?1:-1)),g*=.9999;for(x=44,S=0;S<k.length;S++)for(y=k.charCodeAt(S)-64,b=2*Math.PI*55*Math.pow(2,y/12)/22050,g=.1,m=0;4593>m;m++)v[x++]+=127*g*(Math.sin(m*b)>0?1:-1),g*=.9999;U+='<audio id="tis-music" src="'+URL.createObjectURL(new Blob([v],{type:"audio/wav"}))+'" loop'+("#m"==location.hash?"":" autoplay")+"></audio>",v=document.createElement("div"),v.innerHTML=U,document.body.appendChild(v),o(),d(0),document.addEventListener("keydown",a),document.addEventListener("keyup",n)});