document.addEventListener("DOMContentLoaded",function(){function e(e,t,o){return r&&(3&e)==e&&(3&t)==t&&q[r][o]&1<<4*t+e}function t(){for(g=f;r&&!o(s,g+1,c);g++);for(b=0;N>b;b++)for(m=0;O>m;m++)x=b*O+m,M[x]=e(m-s,b-f,c)?r:e(m-s,b-g,c)?r+7:C[x]||0,(y=document.getElementById("tis-"+x))&&(y.style.background=E[M[x]]);g='<div style="text-align:right;font-size:150%">',document.getElementById("tis-status").innerHTML="Score"+g+I+"</div>Lines"+g+Y+"</div>Level"+g+$+"</div>"}function o(t,o,i){for(b=o;o+4>b;b++)for(m=t;t+4>m;m++)if(e(m-t,b-o,i)&&(0>m||m>=O||0>b||b>=N||C[b*O+m]))return 1;return 0}function i(){if(!G.length){for(x=0;7>x;x++)G[x]=x+1;for(x=0;7>x;x++)S=Math.floor(7*Math.random()),g=G[S],G[S]=G[x],G[x]=g}r=G.shift(),s=3,f=0,c=0,h=0,A=0,t()}function a(e){switch(u=(e-l)/1e3||0,l=e,K){case 1:if(p>1){for(m=0;O>m;m++)C[p*O+m]=1+Math.floor(7*Math.random());t(),p--}break;case 0:for(v in H){switch(parseInt(v)){case 37:if(H[v]<0)break;H[v]-=B,o(s-1,f,c)||(s--,A=0,t());break;case 39:if(H[v]<0)break;H[v]-=B,o(s+1,f,c)||(s++,A=0,t());break;case 38:if(H[v])break;for(;!o(s,f+1,c);)f++;A=9;break;case 90:case 186:H[v]||o(s,f,(c+3)%4)||(c=(c+3)%4,A=0,t());break;case 88:case 81:H[v]||o(s,f,(c+1)%4)||(c=(c+1)%4,A=0,t())}H[v]+=u}if(h+=Math.max(H[40]?.2:0,u*($+1)/1.5),h>1&&(h=0,o(s,f+1,c)||(f++,A=0,t())),A>1&&o(s,f+1,c)){for(t(),x=0;T>x;x++)C[x]=M[x];for(v=0,b=0;N>b;b++){for(g=1,m=0;O>m;m++)if(!C[b*O+m]){g=0;break}if(g)for(v++,x=b*O+O-1;x>=0;x--)C[x]=C[x-O]}I+=[0,100,300,500,800][v]*$,Y+=v,$=1+Math.floor(Y/10),i(),o(s,f,c)&&(K=1,p=N),t()}A+=u}window.requestAnimationFrame(a)}function d(e){77==e.keyCode&&(g=document.getElementById("tis-music"),g.paused?g.play():g.pause()),H[e.keyCode]||(H[e.keyCode]=0)}function n(e){delete H[e.keyCode]}var r,s,f,c,p,h,u,l,x,S,m,b,g,v,y,L=(document.getElementById("tis-grid"),["`+,^,+Y),`.,C,^`\\Yq^.1e31H,01.,C,^`\\Yq","T$$T,+)$),Y))<$TTYTl.).1^..D,\\.,<$TTTTT`"]),k="GNKNGNKNLSOSLSOSKSNSKSNSLSNSL@BCESOSESOSCOCOCOCOBNBN?J?J@CGL@@@@",w="LSOSLSOSKSNSKSNSLSOSLSOSKSNSKSNS",C=[],M=[],O=10,N=22,T=O*N,E="#080808 #0dd #36f #e80 #dd0 #0e0 #c0c #f22 #002c2c #0a1433 #301b00 #2c2c00 #003000 #290029 #330707".split(" "),q=[,[240,17476,3840,8738],[113,550,1136,802],[116,1570,368,547],[102,102,102,102],[54,1122,864,561],[114,610,624,562],[99,612,1584,306]],B=.15,K=0,I=0,Y=0,$=1,A=0,G=[],H=[],U='<div id="tis-root" style="position:fixed;width:280px;height:400px;left:50%;top:50%;margin:-240px -160px;background:rgba(0,0,0,0.8);box-shadow:0 0 30px #000;border-radius:30px;padding:40px"><div id="tis-grid" style="background:#000;width:200px;height:400px;box-shadow:0 0 10px #222;">';for(L[0]=L[0]+L[0]+"xtvstqpsxtvs\\`}|x",L[1]=L[1]+L[1]+"tqspqqpptqspY`xx",k=k+k+w+w,x=0;T>x;x++)C.push(0),x>19&&(U+='<div id="tis-'+x+'" style="width:20px;height:20px;float:left;box-shadow:-2px -2px 8px rgba(0,0,0,0.4) inset, 0 0 2px #000 inset;"></div>');for(U+='</div><div id="tis-status" style="position:absolute;right:20px;top:40px;width:80px;color:#eee;font:normal 15px sans-serif"></div></div>',v=881856,g=new Uint8Array(v+44),g.set([82,73,70,70,v+36&255,v+36>>8&255,v+36>>16,0,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,34,86,0,0,34,86,0,0,1,0,8,0,100,97,116,97,255&v,v>>8&255,v>>16,0]),u=0;2>u;u++)for(x=44,S=0;S<L[u].length;S++)for(y=L[u].charCodeAt(S)-32,m=2*Math.PI*261.63*Math.pow(2,y%24/12)/22050,v=.2-.1*u,b=0;b<4593*[1,3,2,4][Math.floor(y/24)];b++)g[x++]+=127*(1-u+v*(Math.sin(b*m)>0?1:-1)),v*=.9999;for(x=44,S=0;S<k.length;S++)for(y=k.charCodeAt(S)-64,m=2*Math.PI*55*Math.pow(2,y/12)/22050,v=.1,b=0;4593>b;b++)g[x++]+=127*v*(Math.sin(b*m)>0?1:-1),v*=.9999;U+='<audio id="tis-music" src="'+URL.createObjectURL(new Blob([g],{type:"audio/wav"}))+'" loop'+("#m"==location.hash?"":" autoplay")+"></audio>",g=document.createElement("div"),g.innerHTML=U,document.body.appendChild(g),i(),a(0),document.addEventListener("keydown",d),document.addEventListener("keyup",n)});