document.addEventListener("DOMContentLoaded",function(){function e(e,t,o){return s&&(3&e)==e&&(3&t)==t&&I[s][o]&1<<4*t+e}function t(){for(y=c;s&&!o(f,y+1,p);y++);for(g=0;q>g;g++)for(m=0;E>m;m++)S=g*E+m,N[S]=e(m-f,g-c,p)?s:e(m-f,g-y,p)?s+7:T[S]||0,M[S]&&(M[S].style.background=K[N[S]]);y='<div style="text-align:right;font-size:150%">',d.innerHTML="Score"+y+$+"</div>Lines"+y+A+"</div>Level"+y+G+"</div>"}function o(t,o,i){for(g=o;o+4>g;g++)for(m=t;t+4>m;m++)if(e(m-t,g-o,i)&&(0>m||m>=E||0>g||g>=q||T[g*E+m]))return 1;return 0}function i(){if(!D.length){for(S=0;7>S;S++)D[S]=S+1;for(S=0;7>S;S++)b=Math.floor(7*Math.random()),y=D[b],D[b]=D[S],D[S]=y}s=D.shift(),f=3,c=0,p=0,u=0,U=0,t()}function n(e){switch(l=(e-x)/1e3||0,x=e,H){case 1:if(h>1){for(m=0;E>m;m++)T[h*E+m]=1+Math.floor(7*Math.random());t(),h--}break;case 0:for(L in J){switch(parseInt(L)){case 37:if(J[L]<0)break;J[L]-=Y,o(f-1,c,p)||(f--,U=0,t());break;case 39:if(J[L]<0)break;J[L]-=Y,o(f+1,c,p)||(f++,U=0,t());break;case 38:if(J[L])break;for(;!o(f,c+1,p);)c++;U=9;break;case 90:case 186:J[L]||o(f,c,(p+3)%4)||(p=(p+3)%4,U=0,t());break;case 88:case 81:J[L]||o(f,c,(p+1)%4)||(p=(p+1)%4,U=0,t())}J[L]+=l}if(u+=Math.max(J[40]?.2:0,l*(G+1)/1.5),u>1&&(u=0,o(f,c+1,p)||(c++,U=0,t())),U>1&&o(f,c+1,p)){for(t(),S=0;B>S;S++)T[S]=N[S];for(L=0,g=0;q>g;g++){for(y=1,m=0;E>m;m++)if(!T[g*E+m]){y=0;break}if(y)for(L++,S=g*E+E-1;S>=0;S--)T[S]=T[S-E]}$+=[0,100,300,500,800][L]*G,A+=L,G=1+Math.floor(A/10),i(),o(f,c,p)&&(H=1,h=q),t()}U+=l}window.requestAnimationFrame(n)}function r(e){77==e.keyCode&&(y=document.getElementById("tis-music"),y.paused?y.play():y.pause()),J[e.keyCode]||(J[e.keyCode]=0)}function a(e){delete J[e.keyCode]}document.body.innerHTML+='<div id="tis-root" style="position:fixed;width:280px;height:400px;left:50%;top:50%;margin:-240px -160px;background:rgba(0,0,0,0.8);box-shadow:0 0 30px #000;border-radius:30px;padding:40px"><div id="tis-grid" style="background:#000;width:200px;height:400px;box-shadow:0 0 10px #222;"></div><div id="tis-status" style="position:absolute;right:20px;top:40px;width:80px;color:#eee;font:normal 15px sans-serif"></div></div>';var d,s,f,c,p,h,u,l,x,S,b,m,g,y,L,v,k=document.getElementById("tis-grid"),M=[],w=["`+,^,+Y),`.,C,^`\\Yq^.1e31H,01.,C,^`\\Yq","T$$T,+)$),Y))<$TTYTl.).1^..D,\\.,<$TTTTT`"],C="GNKNGNKNLSOSLSOSKSNSKSNSLSNSL@BCESOSESOSCOCOCOCOBNBN?J?J@CGL@@@@",O="LSOSLSOSKSNSKSNSLSOSLSOSKSNSKSNS",T=[],N=[],E=10,q=22,B=E*q,K="#080808 #0dd #36f #e80 #dd0 #0e0 #c0c #f22 #002c2c #0a1433 #301b00 #2c2c00 #003000 #290029 #330707".split(" "),I=[,[240,17476,3840,8738],[113,550,1136,802],[116,1570,368,547],[102,102,102,102],[54,1122,864,561],[114,610,624,562],[99,612,1584,306]],Y=.15,H=0,$=0,A=0,G=1,U=0,D=[],J=[];for(w[0]=w[0]+w[0]+"xtvstqpsxtvs\\`}|x",w[1]=w[1]+w[1]+"tqspqqpptqspY`xx",C=C+C+O+O,S=0;B>S;S++)T.push(0),S>19&&(k.innerHTML+='<div id="tis-'+S+'" style="width:20px;height:20px;float:left;box-shadow:-2px -2px 8px rgba(0,0,0,0.4) inset, 0 0 2px #000 inset;"></div>');for(L=881856,y=new Uint8Array(L+44),y.set([82,73,70,70,L+36&255,L+36>>8&255,L+36>>16,0,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,34,86,0,0,34,86,0,0,1,0,8,0,100,97,116,97,255&L,L>>8&255,L>>16,0]),l=0;2>l;l++)for(S=44,b=0;b<w[l].length;b++)for(v=w[l].charCodeAt(b)-32,m=2*Math.PI*261.63*Math.pow(2,v%24/12)/22050,L=.2-.1*l,g=0;g<4593*[1,3,2,4][Math.floor(v/24)];g++)y[S++]+=127*(1-l+L*(Math.sin(g*m)>0?1:-1)),L*=.9999;for(S=44,b=0;b<C.length;b++)for(v=C.charCodeAt(b)-64,m=2*Math.PI*55*Math.pow(2,v/12)/22050,L=.1,g=0;4593>g;g++)y[S++]+=127*L*(Math.sin(g*m)>0?1:-1),L*=.9999;for(document.body.innerHTML+='<audio id="tis-music" src="'+URL.createObjectURL(new Blob([y],{type:"audio/wav"}))+'" loop'+("#m"==location.hash?"":" autoplay")+"></audio>",d=document.getElementById("tis-status"),S=20;B>S;S++)M[S]=document.getElementById("tis-"+S);i(),n(0),document.addEventListener("keydown",r),document.addEventListener("keyup",a)});