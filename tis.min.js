document.addEventListener("DOMContentLoaded",function(){function e(e,t,i){return s&&e>=0&&4>e&&t>=0&&4>t&&T[s][i]&1<<4*t+e}function t(){for(v=c;s&&!i(f,v+1,h);v++);for(g=0;B>g;g++)for(y=0;E>y;y++)b=g*E+y,I[b]=e(y-f,g-c,h)?s:e(y-f,g-v,h)?s+7:C[b]||0,L[b]&&(L[b].style.background=H[I[b]]);v='<div style="text-align:right;font-size:150%">',r.innerHTML="Score"+v+U+"</div>Lines"+v+O+"</div>Level"+v+R+"</div>"}function i(t,i,o){for(g=i;i+4>g;g++)for(y=t;t+4>y;y++)if(e(y-t,g-i,o)&&(0>y||y>=E||0>g||g>=B||C[g*E+y]))return 1;return 0}function o(){if(!S.length){for(b=0;7>b;b++)S[b]=b+1;for(b=0;7>b;b++)m=Math.floor(7*Math.random()),v=S[m],S[m]=S[b],S[b]=v}s=S.shift(),f=3,c=0,h=0,p=0,t()}function d(e){switch(l=e-x||0,x=e,F){case 1:if(u>1){for(y=0;E>y;y++)C[u*E+y]=1+Math.floor(7*Math.random());t(),u--}break;case 0:for(k in j){switch(parseInt(k)){case 37:if(j[k]<0)break;j[k]-=q,i(f-1,c,h)||f--;break;case 39:if(j[k]<0)break;j[k]-=q,i(f+1,c,h)||f++;break;case 38:if(j[k])break;for(;!i(f,c+1,h);)c++;p=1;break;case 90:case 186:j[k]||i(f,c,(h+3)%4)||(h=(h+3)%4);break;case 88:case 81:j[k]||i(f,c,(h+1)%4)||(h=(h+1)%4)}j[k]+=l,t()}if(p+=Math.max(j[40]?.2:0,l*(R+1)/1500),p>1){if(p=0,i(f,c+1,h)){for(t(),b=0;A>b;b++)C[b]=I[b];for(k=0,g=0;B>g;g++){for(v=1,y=0;E>y;y++)if(!C[g*E+y]){v=0;break}if(v)for(k++,b=g*E+E-1;b>=0;b--)C[b]=C[b-E]}U+=[0,100,300,500,800][k]*R,O+=k,R=1+Math.floor(O/10),o(),i(f,c,h)&&(F=1,u=B)}else c++;t()}}window.requestAnimationFrame(d)}function n(e){77==e.keyCode&&(v=document.getElementById("tis-music"),v.paused?v.play():v.pause()),j[e.keyCode]||(j[e.keyCode]=0)}function a(e){delete j[e.keyCode]}document.body.innerHTML+='<div id="tis-root" style="position:fixed;width:280px;height:400px;left:50%;top:50%;margin:-240px -160px;background:rgba(0,0,0,0.8);box-shadow:0 0 30px #000;border-radius:30px;padding:40px"><div id="tis-grid" style="background:#000;width:200px;height:400px;box-shadow:0 0 10px #222;"></div><div id="tis-status" style="position:absolute;right:20px;top:40px;width:80px;color:#eee;font:normal 15px sans-serif"></div></div>';var r,s,f,c,h,u,p,l,x,b,m,y,g,v,k,w,M=document.getElementById("tis-grid"),L=[],D="hCDfDCaADhFDSDfhdaQDVImKIXDhFDcCDfhdaq",C=[],I=[],E=10,B=22,A=E*B,H="#080808 #0dd #36f #e80 #dd0 #0e0 #c0c #f22 #002c2c #0a1433 #301b00 #2c2c00 #003000 #290029 #330707".split(" "),T=[,[240,17476,3840,8738],[113,550,1136,802],[116,1570,368,547],[102,102,102,102],[54,1122,864,561],[114,610,624,562],[99,612,1584,306]],q=150,F=0,U=0,O=0,R=1,S=[],j=[];for(D=D+D+"xtvstqpsxtvsdh}|",b=0;A>b;b++)C.push(0),b>19&&(M.innerHTML+='<div id="tis-'+b+'" style="width:20px;height:20px;float:left;box-shadow:-2px -2px 8px rgba(0,0,0,0.4) inset, 0 0 2px #000 inset;"></div>');for(k=882e3,v=new Uint8Array(k+44),v.set([82,73,70,70,k+36&255,k+36>>8&255,k+36>>16,0,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,34,86,0,0,34,86,0,0,1,0,8,0,100,97,116,97,255&k,k>>8&255,k>>16,0]),b=44,m=0;m<D.length;m++)for(w=D.charCodeAt(m)-64,y=2*Math.PI*440*Math.pow(2,(15&w)/12)/22050,m>75&&(y/=2),k=m>75?.8:1,g=0;g<[4593,13781,9187,18375][w>>4];g++)v[b++]=k*(Math.sin(g*y)>0?255:0)+127*(1-k),k*=m>75?.99997:.9999;for(document.body.innerHTML+='<audio id="tis-music" src="'+URL.createObjectURL(new Blob([v],{type:"audio/wav"}))+'" loop'+("#m"==location.hash?"":" autoplay")+"></audio>",r=document.getElementById("tis-status"),b=20;A>b;b++)L[b]=document.getElementById("tis-"+b);o(),d(0),document.addEventListener("keydown",n),document.addEventListener("keyup",a)});