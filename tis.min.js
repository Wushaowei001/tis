document.addEventListener("DOMContentLoaded",function(){function e(e,t,i){return s&&e>=0&&4>e&&t>=0&&4>t&&T[s][i]&1<<4*t+e}function t(){for(g=c;s&&!i(f,g+1,u);g++);for(v=0;B>v;v++)for(y=0;I>y;y++)m=v*I+y,E[m]=e(y-f,v-c,u)?s:e(y-f,v-g,u)?s+7:C[m]||0,L[m]&&(L[m].style.background=H[E[m]]);g='<div style="text-align:right;font-size:150%">',a.innerHTML="Score"+g+U+"</div>Lines"+g+O+"</div>Level"+g+R+"</div>"}function i(t,i,o){for(v=i;i+4>v;v++)for(y=t;t+4>y;y++)if(e(y-t,v-i,o)&&(0>y||y>=I||0>v||v>=B||C[v*I+y]))return 1;return 0}function o(){if(!S.length){for(m=0;7>m;m++)S[m]=m+1;for(m=0;7>m;m++)b=Math.floor(7*Math.random()),g=S[b],S[b]=S[m],S[m]=g}s=S.shift(),f=3,c=0,u=0,p=0,t()}function n(e){switch(l=e-x||0,x=e,F){case 1:if(h>1){for(y=0;I>y;y++)C[h*I+y]=1+Math.floor(7*Math.random());t(),h--}break;case 0:for(k in j){switch(parseInt(k)){case 37:if(j[k]<0)break;j[k]-=q,i(f-1,c,u)||f--;break;case 39:if(j[k]<0)break;j[k]-=q,i(f+1,c,u)||f++;break;case 38:if(j[k])break;for(;!i(f,c+1,u);)c++;p=1;break;case 90:case 186:j[k]||i(f,c,(u+3)%4)||(u=(u+3)%4);break;case 88:case 81:j[k]||i(f,c,(u+1)%4)||(u=(u+1)%4)}j[k]+=l,t()}if(p+=Math.max(j[40]?.2:0,l*(R+1)/1500),p>1){if(p=0,i(f,c+1,u)){for(t(),m=0;A>m;m++)C[m]=E[m];for(k=0,v=0;B>v;v++){for(g=1,y=0;I>y;y++)if(!C[v*I+y]){g=0;break}if(g)for(k++,m=v*I+I-1;m>=0;m--)C[m]=C[m-I]}U+=[0,100,300,500,800][k]*R,O+=k,R=1+Math.floor(O/10),o(),i(f,c,u)&&(document.removeEventListener("keydown",d),F=1,h=B)}else c++;t()}}window.requestAnimationFrame(n)}function d(e){77==e.keyCode&&(g=document.getElementById("tis-music"),g.paused?g.play():g.pause()),j[e.keyCode]||(j[e.keyCode]=0)}function r(e){delete j[e.keyCode]}document.body.innerHTML+='<div id="tis-root" style="position:fixed;width:280px;height:400px;left:50%;top:50%;margin:-240px -160px;background:rgba(0,0,0,0.8);box-shadow:0 0 30px #000;border-radius:30px;padding:40px"><div id="tis-grid" style="background:#000;width:200px;height:400px;box-shadow:0 0 10px #222;"></div><div id="tis-status" style="position:absolute;right:20px;top:40px;width:80px;color:#eee;font:normal 15px sans-serif"></div></div>';var a,s,f,c,u,h,p,l,x,m,b,y,v,g,k,w,M=document.getElementById("tis-grid"),L=[],D="hCDfDCaADhFDSDfhdaQDVImKIXDhFDcCDfhdaq",C=[],E=[],I=10,B=22,A=I*B,H="#080808 #0dd #36f #e80 #dd0 #0e0 #c0c #f22 #002c2c #0a1433 #301b00 #2c2c00 #003000 #290029 #330707".split(" "),T=[,[240,17476,3840,8738],[113,550,1136,802],[116,1570,368,547],[102,102,102,102],[54,1122,864,561],[114,610,624,562],[99,612,1584,306]],q=150,F=0,U=0,O=0,R=1,S=[],j=[];for(D=D+D+"xtvstqpsxtvsdh}|",m=0;A>m;m++)C.push(0),m>19&&(M.innerHTML+='<div id="tis-'+m+'" style="width:20px;height:20px;float:left;box-shadow:-2px -2px 8px rgba(0,0,0,0.4) inset, 0 0 2px #000 inset;"></div>');for(k=882e3,g=new Uint8Array(k+44),g.set([82,73,70,70,k+36&255,k+36>>8&255,k+36>>16,0,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,34,86,0,0,34,86,0,0,1,0,8,0,100,97,116,97,255&k,k>>8&255,k>>16,0]),m=44,b=0;b<D.length;b++)for(w=D.charCodeAt(b)-64,y=2*Math.PI*440*Math.pow(2,(15&w)/12)/22050,b>75&&(y/=2),k=b>75?.8:1,v=0;v<[4593,13781,9187,18375][w>>4];v++)g[m++]=k*(Math.sin(v*y)>0?255:0)+127*(1-k),k*=b>75?.99997:.9999;for(document.body.innerHTML+='<audio id="tis-music" src="'+URL.createObjectURL(new Blob([g],{type:"audio/wav"}))+'" autoplay loop></audio>',a=document.getElementById("tis-status"),m=20;A>m;m++)L[m]=document.getElementById("tis-"+m);o(),n(0),document.addEventListener("keydown",d),document.addEventListener("keyup",r)});