document.addEventListener("DOMContentLoaded",function(){function e(e,t,i){return a&&e>=0&&4>e&&t>=0&&4>t&&T[a][i]&1<<4*t+e}function t(){for(v=f;a&&!i(s,v+1,c);v++);for(m=0;I>m;m++)for(g=0;C>g;g++)l=m*C+g,E[l]=e(g-s,m-f,c)?a:e(g-s,m-v,c)?a+7:M[l]||0,w[l]&&(w[l].style.background=H[E[l]]);v='<div style="text-align:right;font-size:150%">',L.innerHTML="Score"+v+A+"</div>Lines"+v+D+"</div>Level"+v+F+"</div>"}function i(t,i,o){for(m=i;i+4>m;m++)for(g=t;t+4>g;g++)if(e(g-t,m-i,o)&&(0>g||g>=C||0>m||m>=I||M[m*C+g]))return 1;return 0}function o(){if(!O.length){for(l=0;7>l;l++)O[l]=l+1;for(l=0;7>l;l++)b=Math.floor(7*Math.random()),v=O[b],O[b]=O[l],O[l]=v}a=O.shift(),s=3,f=0,c=0,u=0}function n(e){switch(h=e-x||0,x=e,z){case 1:if(p>1){for(g=0;C>g;g++)M[p*C+g]=1+Math.floor(7*Math.random());t(),p--}break;case 0:for(k in S){switch(parseInt(k)){case 37:if(S[k]<0)break;S[k]-=q,i(s-1,f,c)||s--;break;case 39:if(S[k]<0)break;S[k]-=q,i(s+1,f,c)||s++;break;case 38:if(S[k])break;for(;!i(s,f+1,c);)f++;u=1;break;case 90:case 186:S[k]||i(s,f,(c+3)%4)||(c=(c+3)%4);break;case 88:case 81:S[k]||i(s,f,(c+1)%4)||(c=(c+1)%4)}S[k]+=h,t()}if(u+=Math.max(S[40]?.2:0,h*(F+1)/1500),u>1){if(u=0,i(s,f+1,c)){for(t(),l=0;B>l;l++)M[l]=E[l];for(k=0,m=0;I>m;m++){for(v=1,g=0;C>g;g++)if(!M[m*C+g]){v=0;break}if(v)for(k++,l=m*C+C-1;l>=0;l--)M[l]=M[l-C]}A+=[0,100,300,500,800][k]*F,D+=k,F=1+Math.floor(D/10),o(),i(s,f,c)&&(document.removeEventListener("keydown",d),p=I)}else f++;t()}}window.requestAnimationFrame(n)}function d(e){S[e.keyCode]||(S[e.keyCode]=0)}function r(e){delete S[e.keyCode]}document.body.innerHTML+='<div id="tis-root" style="position:fixed;width:280px;height:400px;left:50%;top:50%;margin:-240px -160px;background:rgba(0,0,0,0.8);box-shadow:0 0 30px #000;border-radius:30px;padding:40px"><div id="tis-grid" style="background:#000;width:200px;height:400px;box-shadow:0 0 10px #222;"></div><div id="tis-status" style="position:absolute;right:20px;top:40px;width:80px;color:#eee;font:normal 15px sans-serif"></div></div>';var a,s,f,c,p,u,h,x,l,b,g,m,v,k,y=document.getElementById("tis-grid"),w=[],L=document.getElementById("tis-status"),M=[],E=[],C=10,I=22,B=C*I,H="#080808 #0dd #36f #e80 #dd0 #0e0 #c0c #f22 #002c2c #0a1433 #301b00 #2c2c00 #003000 #290029 #330707".split(" "),T=[,[240,17476,3840,8738],[113,550,1136,802],[116,1570,368,547],[102,102,102,102],[54,1122,864,561],[114,610,624,562],[99,612,1584,306]],q=150,z=0,A=0,D=0,F=1,O=[],S=[];for(l=0;B>l;l++)M.push(0),l>19&&(y.innerHTML+='<div id="tis-'+l+'" style="width:20px;height:20px;float:left;box-shadow:-2px -2px 8px rgba(0,0,0,0.4) inset, 0 0 2px #000 inset;"></div>');for(l=20;B>l;l++)w[l]=document.getElementById("tis-"+l);o(),n(0),document.addEventListener("keydown",d),document.addEventListener("keyup",r)});