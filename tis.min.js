document.addEventListener("DOMContentLoaded",function(){function e(e,t,i,o){return n&&(3&e)==e&&(3&t)==t&&E[o||n][i]&1<<4*t+e}function t(){for(m=s;n&&!i(r,m+1,f);m++);for(b=0;N+4>b;b++)for(S=0;M>S;S++)l=b*M+S,b>=N&&(w[l]=e(S,b-N,0,A[0])?A[0]:0),C[l]=e(S-r,b-s,f)?n:e(S-r,b-m,f)?n+7:w[l]||0,(g=document.getElementById("tis-"+l))&&(g.style.background=T[C[l]]);m='<div style="text-align:right;font-size:150%">',document.getElementById("tis-status").innerHTML="Score"+m+K+"</div>Lines"+m+I+"</div>Level"+m+Y+"</div>"}function i(t,i,o){for(b=i;i+4>b;b++)for(S=t;t+4>S;S++)if(e(S-t,b-i,o)&&(0>S||S>=M||0>b||b>=N||w[b*M+S]))return 1;return 0}function o(e){switch(h=(e-u)/1e3||0,u=e,B){case 1:if(c>1){for(S=0;M>S;S++)w[c*M+S]=1+Math.floor(7*Math.random());t(),c--}break;case 0:for(v in G){switch(parseInt(v)){case 37:if(G[v]<0)break;G[v]-=q,i(r-1,s,f)||(r--,$=0,t());break;case 39:if(G[v]<0)break;G[v]-=q,i(r+1,s,f)||(r++,$=0,t());break;case 38:if(G[v])break;for(;!i(r,s+1,f);)s++;$=9;break;case 90:case 186:G[v]||i(r,s,(f+3)%4)||(f=(f+3)%4,$=0,t());break;case 88:case 81:G[v]||i(r,s,(f+1)%4)||(f=(f+1)%4,$=0,t())}G[v]+=h}if(p+=Math.max(G[40]?.2:0,h*(Y+1)/1.5),p>1&&(p=0,i(r,s+1,f)||(s++,$=0,t())),!n||$>1&&i(r,s+1,f)){for(t(),l=0;O>l;l++)w[l]=C[l];for(v=0,b=0;N>b;b++){for(m=1,S=0;M>S;S++)if(!w[b*M+S]){m=0;break}if(m)for(v++,l=b*M+M-1;l>=0;l--)w[l]=w[l-M]}if(K+=[0,100,300,500,800][v]*Y,I+=v,Y=1+Math.floor(I/10),A.length<2)for(m=1,l=0;7>l;l++){for(x=0;m&1<<x;)x=Math.ceil(7*Math.random());m|=1<<x,A.push(x)}n=A.shift(),r=3,s=0,f=0,p=0,$=0,i(r,s,f)&&(B=1,c=N),t()}$+=h}window.requestAnimationFrame(o)}function d(e){77==e.keyCode&&(m=document.getElementById("tis-music"),m.paused?m.play():m.pause()),G[e.keyCode]||(G[e.keyCode]=0)}function a(e){delete G[e.keyCode]}var n,r,s,f,c,p,h,u,l,x,S,b,m,v,g,y=(document.getElementById("tis-grid"),["`+,^,+Y),`.,C,^`\\Yq^.1e31H,01.,C,^`\\Yq","T$$T,+)$),Y))<$TTYTl.).1^..D,\\.,<$TTTTT`"]),L="GNKNGNKNLSOSLSOSKSNSKSNSLSNSL@BCESOSESOSCOCOCOCOBNBN?J?J@CGL@@@@",k="LSOSLSOSKSNSKSNSLSOSLSOSKSNSKSNS",w=[],C=[],M=10,N=22,O=M*N+20,T="#080808 #0dd #36f #e80 #dd0 #0e0 #c0c #f22 #002c2c #0a1433 #301b00 #2c2c00 #003000 #290029 #330707".split(" "),E=[,[240,17476,3840,8738],[113,550,1136,802],[116,1570,368,547],[102,102,102,102],[54,1122,864,561],[114,610,624,562],[99,612,1584,306]],q=.15,B=0,K=0,I=0,Y=1,$=0,A=[],G=[],H='<div id="tis-root" style="position:fixed;width:280px;height:400px;left:50%;top:50%;margin:-240px -160px;background:rgba(0,0,0,0.8);box-shadow:0 0 30px #000;border-radius:30px;padding:40px"><div id="tis-grid" style="background:#000;width:200px;height:400px;box-shadow:0 0 10px #222;">';for(y[0]=y[0]+y[0]+"xtvstqpsxtvs\\`}|x",y[1]=y[1]+y[1]+"tqspqqpptqspY`xx",L=L+L+k+k,v='" style="width:20px;height:20px;float:left;box-shadow:-2px -2px 8px rgba(0,0,0,0.4) inset, 0 0 2px #000 inset;"></div>',l=0;O>l;l++)w.push(0),l>19&&220>l&&(H+='<div id="tis-'+l+v);for(H+='</div><div style="position:absolute;right:20px;top:40px;width:80px;color:#eee;font:normal 15px sans-serif"><div id="tis-status"></div>Next<br>',l=220;O>l;l++)4>l%M&&(H+='<div id="tis-'+l+v);for(H+="</div></div>",v=881856,m=new Uint8Array(v+44),m.set([82,73,70,70,v+36&255,v+36>>8&255,v+36>>16,0,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,34,86,0,0,34,86,0,0,1,0,8,0,100,97,116,97,255&v,v>>8&255,v>>16,0]),h=0;2>h;h++)for(l=44,x=0;x<y[h].length;x++)for(g=y[h].charCodeAt(x)-32,S=2*Math.PI*261.63*Math.pow(2,g%24/12)/22050,v=.2-.1*h,b=0;b<4593*[1,3,2,4][Math.floor(g/24)];b++)m[l++]+=127*(1-h+v*(Math.sin(b*S)>0?1:-1)),v*=.9999;for(l=44,x=0;x<L.length;x++)for(g=L.charCodeAt(x)-64,S=2*Math.PI*55*Math.pow(2,g/12)/22050,v=.1,b=0;4593>b;b++)m[l++]+=127*v*(Math.sin(b*S)>0?1:-1),v*=.9999;H+='<audio id="tis-music" src="'+URL.createObjectURL(new Blob([m],{type:"audio/wav"}))+'" loop'+("#m"==location.hash?"":" autoplay")+"></audio>",m=document.createElement("div"),m.innerHTML=H,document.body.appendChild(m),o(0),document.addEventListener("keydown",d),document.addEventListener("keyup",a)});